{% extends 'back-office/reclamation/backbase.html.twig' %}

{% block title %}Liste des Utilisateurs{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="text-center">Liste des Utilisateurs</h1>

    <!-- Recherche -->
    <form method="get" action="{{ path('admin_users') }}" class="mb-3">
        <input type="text" name="q" class="form-control" id="searchInput" placeholder="Rechercher par nom ou email..." onkeyup="fetchUserResults()">
    </form>

    <!-- Filtrage par r√¥le -->
    <form method="get" action="{{ path('admin_users') }}" class="form-inline mb-3">
        <label for="role" class="mr-2">Filtrer par r√¥le :</label>
        <select name="role" id="role" class="form-control" onchange="this.form.submit()">
            <option value="">-- Tous les r√¥les --</option>
            <option value="ROLE_USER">Utilisateur</option>
            <option value="ROLE_ADMIN">Admin</option>
        </select>
    </form>

    <table class="table table-bordered table-striped mt-3">
        <thead class="table-dark">
            <tr>
                <th><a href="#" onclick="sortTable(0)">Nom ‚¨ç</a></th>
                <th><a href="#" onclick="sortTable(1)">Pr√©nom ‚¨ç</a></th>
                <th><a href="#" onclick="sortTable(2)">Email ‚¨ç</a></th>
                <th>T√©l√©phone</th>
                <th>R√¥le</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for user in users %}
                <tr>
                    <td>{{ user.nom }}</td>
                    <td>{{ user.prenom }}</td>
                    <td>{{ user.email }}</td>
                    <td>{{ user.telephonne }}</td>
                    <td>{{ user.roles[0] }}</td>
                    <td>
                        {# Voir d√©tails (optionnel) #}
                        <a href="#" class="btn btn-info btn-sm">Voir</a>

                        {# Suppression #}
                        <form action="{{ path('user_delete', {'id': user.idUser}) }}" method="post" style="display:inline;">
                            <input type="hidden" name="_method" value="DELETE">
                            <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ user.idUser) }}">
                            <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('√ätes-vous s√ªr ?')">üóë Supprimer</button>
                        </form>
                    </td>
                </tr>
            {% else %}
                <tr><td colspan="6" class="text-center">Aucun utilisateur trouv√©.</td></tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Scripts tri/recherche -->
<script>
function sortTable(columnIndex) {
    let table = document.querySelector("table tbody");
    let rows = Array.from(table.rows);
    let sortedRows = rows.sort((a, b) => {
        let aText = a.cells[columnIndex].textContent.trim();
        let bText = b.cells[columnIndex].textContent.trim();
        return aText.localeCompare(bText);
    });
    table.innerHTML = "";
    sortedRows.forEach(row => table.appendChild(row));
}

function fetchUserResults() {
    let query = document.getElementById('searchInput').value;
    fetch(`{{ path('admin_users') }}?q=${encodeURIComponent(query)}`)
        .then(response => response.text())
        .then(html => {
            let parser = new DOMParser();
            let doc = parser.parseFromString(html, 'text/html');
            let newTable = doc.querySelector("tbody");
            document.querySelector("tbody").innerHTML = newTable.innerHTML;
        });
}
</script>
{% endblock %}
